# ETL_boxbase_to_visual_tests.md

## Логическая спецификация ETL
### Преобразование legacy-таблицы `boxbase` в аналитическое представление `visual_tests`

---

## 1. Назначение документа

Настоящий документ описывает **логическую (не реализационную) спецификацию ETL-процесса**
преобразования исторических данных тестирования скоростей зрительных реакций
из legacy-таблицы `boxbase` в целевую аналитическую таблицу `visual_tests`.

Документ:

- фиксирует **смысл данных и их преобразования**;
- не зависит от языка программирования, СУБД и конкретной реализации;
- предназначен для долгосрочного использования и воспроизводимости анализа.

---

## 2. Зачем нужен ETL `boxbase → visual_tests`

ETL-процесс необходим для **явного выделения объекта анализа**.

`boxbase` является:
- таблицей исторического хранения;
- оптимизированной под Access и массовый сбор данных;
- представленной в виде широкого набора полей без явной объектной структуры.

`visual_tests` предназначена для:
- представления теста как логически целостного объекта;
- последующего расчёта агрегатов;
- контроля качества (QC);
- лонгитюдинного анализа.

ETL не предназначен для анализа данных.
Его единственная задача — **формализовать и зафиксировать смысл теста как объекта**.

---

## 3. Каноническое определение одной записи `visual_tests`

**Одна запись `visual_tests` соответствует:**

> одному завершённому зрительному тесту  
> одного пациента  
> в одной сессии  
> при фиксированном типе теста.

---

## 4. Идентификационный слой

Каждая запись `visual_tests` однозначно определяется следующей комбинацией:

- `patient_id`
- `session_id`
- `test_type` ∈ {Tst1, Tst2, Tst3}

### Инвариант
Комбинация (`patient_id`, `session_id`, `test_type`) является уникальной.

---

## 5. Отображение данных из `boxbase`

### 5.1. Общий принцип

**Одна строка `boxbase` → три записи `visual_tests`**,  
по одной записи для каждого теста: Tst1, Tst2, Tst3.

Все три записи относятся к:
- одному пациенту;
- одной сессии тестирования;
- одному моменту проведения обследования.

---

### 5.2. Отображение RT

В `boxbase` значения RT представлены как набор отдельных полей.
В `visual_tests` они представлены как структурированное целое.

| Источник (`boxbase`) | Назначение (`visual_tests`) | Смысл |
|---------------------|-----------------------------|-------|
| `Tst1_RT_01 … Tst1_RT_36` | `rt_values[]` | Финальные RT теста Tst1 |
| `Tst2_RT_01 … Tst2_RT_36` | `rt_values[]` | Финальные RT теста Tst2 |
| `Tst3_RT_01 … Tst3_RT_36` | `rt_values[]` | Финальные RT теста Tst3 |

### Принципы
- используются **только финальные значения RT**;
- порядок RT сохраняется;
- интерпретация порядка возможна только через метаданные теста.

---

### 5.3. Пропуски и преждевременные реакции

В `boxbase` присутствуют **агрегированные счётчики**, которые переносятся без изменений.

| Источник (`boxbase`) | Назначение (`visual_tests`) |
|---------------------|-----------------------------|
| `TstX_MissedCount` | `missed_count` |
| `TstX_PrematureCount` | `premature_count` |

### Принципы
- счётчики не связаны с конкретными RT;
- позиции и значения пропущенных/преждевременных попыток отсутствуют принципиально.

---

## 6. Время проведения тестирования (критически важное уточнение)

### 6.1. Факт данных

Время проведения тестирования:
- зафиксировано в `boxbase`;
- является **физиологически и методически значимым параметром**;
- отражает состояние организма на момент обследования;
- имеет значение как разово, так и в динамике;
- используется для сопоставлений «до / после нагрузки».

### 6.2. Статус в ETL

В рамках ETL:

- время тестирования **не теряется**;
- **не используется** для расчёта RT;
- переносится как **атрибут уровня теста или сессии**.

Допустимые варианты:
- `test_datetime` в `visual_tests`, или
- `session_datetime` в `testing_sessions`.

### Инвариант
Время тестирования сохраняется как обязательный контекст анализа.

---

## 7. Метаданные теста

Параметры стимулов (цвет, позиция, предстимульный интервал, структура серий):

- **не дублируются** в `visual_tests`;
- хранятся в специализированном слое метаданных;
- воспроизводимы через `test_type` или идентификатор протокола.

`visual_tests` содержит ссылку на метаданные, но не их копию.

---

## 8. Что принципиально отсутствует в `visual_tests`

В `visual_tests` **не может быть**:

- истории повторных предъявлений;
- временных меток отдельных попыток;
- признаков «какая попытка была повтором»;
- причин пропусков и преждевременных реакций;
- моторных компонентов реакции;
- агрегатов (медиана, MAD и т. п.);
- интерпретаций (каналы, нейромедиаторы).

Это не ограничения реализации, а **методологические границы данных**.

---

## 9. Контрольные инварианты ETL

ETL считается корректным, если выполняются все условия:

1. Из одной строки `boxbase` формируются **ровно три записи** `visual_tests`.
2. Каждая запись содержит:
   - набор финальных RT;
   - корректные значения `missed_count` и `premature_count`;
   - сохранённый временной контекст тестирования.
3. Ни одно значение RT не вычисляется и не модифицируется.
4. На этапе ETL **не выполняется анализ и агрегация**.

---

## 10. Граница ответственности ETL

ETL:

- **завершается** созданием записей `visual_tests`;
- **не включает** расчёт агрегатов;
- **не включает** контроль качества (QC);
- **не включает** интерпретацию результатов.

Все последующие этапы работают **поверх `visual_tests`**.

---

## 11. Статус документа

Данный документ является:

- логической спецификацией ETL;
- независимым от реализации;
- нормативным для всех будущих реализаций переноса данных
  `boxbase → visual_tests`.

Изменения в документе допускаются только при:
- изменении структуры исходных данных;
- изменении методологии тестирования;
- расширении протокола регистрации данных.
