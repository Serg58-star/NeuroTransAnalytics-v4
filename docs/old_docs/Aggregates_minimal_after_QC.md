Aggregates_minimal_after_QC.md
Формализация первого агрегатного расчёта поверх visual_tests
1. Назначение документа

Документ фиксирует первый обязательный агрегатный расчёт, который:

замыкает архитектурную цепочку ETL → QC → Aggregates;

опирается только на QC-валидные записи visual_tests;

не вводит интерпретаций и не изменяет исходные данные;

воспроизводим при повторном запуске на тех же данных.

2. Место агрегатного расчёта в архитектуре

Последовательность слоёв:

boxbase
  ↓
ETL → visual_tests
  ↓
QC_after_ETL
  ↓
Aggregates_minimal   ← (настоящий документ)
  ↓
analysis_results / longitudinal_analysis


Агрегаты считаются исключительно из visual_tests, с учётом статуса QC.

3. Объект агрегирования

Единица агрегирования:

одна запись visual_tests
(один тест одного пациента в одной сессии).

Агрегаты не объединяют разные тесты, разные сессии или разных пациентов.

4. Предусловия расчёта (QC-гейтинг)

В расчёт допускаются записи со статусом:

QC_OK

QC_LIMITED

Записи со статусом QC_INVALID исключаются из расчёта,
но сохраняются в базе без изменений.

5. Входные данные агрегирования

Из записи visual_tests используются только:

rt_values[] — финальные значения RT;

missed_count — число пропусков;

premature_count — число преждевременных реакций;

test_type;

временной контекст тестирования;

идентификаторы (patient_id, session_id).

Никакие внешние данные и метаданные не подтягиваются.

6. Набор минимальных агрегатов
6.1. Центральная тенденция

Медиана RT (median_rt)

основной агрегат теста;

устойчива к выбросам;

не требует предположений о распределении.

6.2. Вариабельность

MAD (mad_rt) — median absolute deviation

предпочтительная мера разброса;

рассчитывается относительно медианы;

устойчива к атипичным значениям.

6.3. Объём данных

valid_rt_count

число валидных значений RT, участвующих в расчётах;

отражает фактическую «плотность» данных теста.

6.4. Контекст выполнения теста

Переносятся без преобразования:

missed_count

premature_count

Эти показатели не участвуют в вычислении median_rt и mad_rt,
но обязательны для интерпретации агрегатов.

7. Явно исключённые агрегаты (на этом этапе)

На первом этапе запрещено рассчитывать:

среднее арифметическое RT;

стандартное отклонение;

коэффициенты асимметрии;

любые пороговые показатели;

индексы «стабильности», «нелинейности» и т. п.

Причина:
минимальный расчёт должен быть устойчивым и предположительно-свободным.

8. Правила расчёта и инварианты
Инварианты:

Агрегаты рассчитываются только из rt_values[].

Ни одно значение RT:

не удаляется;

не заменяется;

не корректируется.

Отсутствие части RT не компенсируется.

Агрегаты однозначно воспроизводимы при повторном расчёте.

9. Выходные данные агрегирования

Результат расчёта формирует одну запись агрегатов, связанную с исходной записью visual_tests.

Минимальный состав выходной записи:

patient_id

session_id

test_type

median_rt

mad_rt

valid_rt_count

missed_count

premature_count

qc_status

временной контекст тестирования

Результаты сохраняются в аналитическом слое
(например, analysis_results).

10. Интерпретационные ограничения

На основании одного агрегатного расчёта запрещено:

делать физиологические выводы;

сравнивать пациентов по абсолютным значениям;

делать выводы о моторных компонентах;

оценивать динамику без повторных сессий.

Допустимы только:

внутриличностные сопоставления;

анализ направленности изменений;

сопоставление тестов в рамках одной сессии.

11. Роль первого агрегатного расчёта

Первый агрегатный расчёт выполняет роль:

методологического якоря;

точки воспроизводимости;

базиса для всех последующих расширений.

Все будущие показатели должны быть:

логически расширениями этого шага,

а не альтернативами ему.

12. Статус документа

Документ является:

нормативной спецификацией первого агрегатного расчёта;

независимым от реализации;

обязательным для всех аналитических модулей проекта.

Изменения допускаются только при:

изменении структуры visual_tests;

изменении QC-гейтинга;

введении новых регистрируемых параметров.

Контрольная фиксация

После утверждения данного документа:

архитектурная цепочка
ETL → QC → Aggregates считается методически завершённой;

проект готов к:

реализации расчётов,

лонгитюдинному анализу,

расширению набора агрегатов.