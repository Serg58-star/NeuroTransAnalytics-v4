# RT_PSI_Data_Contract_v4

## Контракт данных RT × PSI для NeuroTransAnalytics (v4)

> Документ фиксирует **полную модель данных RT × PSI**  
> для тестов **Tst1 (ПЗР)**, **Tst2 (на красный цвет)**, **Tst3 (на сдвиг)**.  
> 
> Назначение документа — служить **справочником и источником истины**  
> при разработке кода, анализе данных и проектировании следующих версий системы.

---

## Оглавление

1. [Назначение документа](#1-назначение-документа)  
2. [Источники данных](#2-источники-данных)  
3. [Общая модель RT × PSI](#3-общая-модель-rt--psi)  
4. [Ключевые идентификаторы](#4-ключевые-идентификаторы)  
5. [Стимульная модель тестов](#5-стимульная-модель-тестов)  
6. [PSI: происхождение и интерпретация](#6-psi-происхождение-и-интерпретация)  
7. [RT: происхождение и ограничения](#7-rt-происхождение-и-ограничения)  
8. [Контекст реакции (Reaction Context)](#8-контекст-реакции-reaction-context)  
9. [Сопоставимость тестов Tst1 / Tst2 / Tst3](#9-сопоставимость-тестов-tst1--tst2--tst3)  
10. [Методологические ограничения и допущения](#10-методологические-ограничения-и-допущения)  
11. [Правила использования контракта](#11-правила-использования-контракта)

---

## 1. Назначение документа

Настоящий документ описывает **структуру, смысл и происхождение данных**,  
используемых в анализе зависимости **RT × PSI**.

Документ предназначен для:

- разработки и сопровождения кода;
- аналитической работы;
- предотвращения методологических ошибок;
- восстановления логики данных без обращения к исходному чату.

Документ **не является аналитическим отчётом**  
и **не навязывает конкретных статистических методов**.

---

## 2. Источники данных

### 2.1 Фактический источник данных v4

**Единственным рабочим источником данных проекта NeuroTransAnalytics v4  
является база SQLite `neuro_data.db`.**

Все расчёты, анализы и сценарии выполняются **исключительно** на данных,
извлекаемых из `neuro_data.db`.

---

### 2.2 Исторические (legacy) источники происхождения данных

Следующие источники использовались **исторически** для формирования базы данных
и описывают происхождение отдельных полей,  
но **не используются напрямую** в аналитическом контуре v4:

| Источник | Роль |
|--------|------|
| `users.xlsx` | исходный контекст субъекта (legacy) |
| `boxbase.xlsx` | исходные реакции RT и параметры сессий (legacy) |
| `test_metadata_old.py` | исходные описания стимулов и PSI (legacy) |
| `stimulus_warmup.xlsx` | предтестовые стимулы (legacy) |

Связь между legacy-источниками и текущей моделью данных
зафиксирована в `Appendix_A_Data_and_Legacy_Context.md`
и в документе маппинга полей.

---

## 3. Общая модель RT × PSI

Каждая строка датасета RT × PSI соответствует:

> **одной реакции одного субъекта  
> на один зачётный тестовый стимул  
> в рамках одной тестовой сессии**

Предтестовые (маскирующие) стимулы:

- **не являются строками датасета**;
- участвуют только через PSI и контекст.

---

## 4. Ключевые идентификаторы

### 4.1 Идентификатор субъекта

| Логическое поле | Источник данных v4 | Происхождение (legacy) | Тип |
|----------------|--------------------|------------------------|-----|
| `subject_id` | `neuro_data.db` (таблица `users`) | `users.xlsx (ID)` | int |

Примечание:

- `subject_id` — системный идентификатор v4;
- исходные идентификаторы сохранены как legacy-атрибуты при необходимости трассировки.

---

### 4.2 Идентификатор сессии

| Логическое поле | Источник данных v4 | Происхождение (legacy) | Тип |
|----------------|--------------------|------------------------|-----|
| `session_id` | `neuro_data.db` (таблица `trials`) | `boxbase.xlsx (cnt)` | int |

---

## 5. Стимульная модель тестов

### 5.1 stimulus_index

`stimulus_index` — **порядковый номер зачётного тестового сигнала**,  
отсчитываемый **от начала тестовой серии**.

| Тест | Диапазон |
|----|----------|
| Tst1 | 1 … 36 |
| Tst2 | 1 … 36 |
| Tst3 | 1 … 36 |

Важно:

- `stimulus_index` **не равен** числу предтестовых троек;
- во всех тестах он описывает **одну и ту же сущность** —
  позицию тестового события в серии.

---

### 5.2 Атрибуты тестовых стимулов

#### Tst1 (ПЗР)

| Поле | Источник данных v4 | Происхождение (legacy) |
|----|--------------------|------------------------|
| `stimulus_color` | `neuro_data.db` (таблица `metadata_simple`) | `test_metadata_old.py` |
| `stimulus_location` | `neuro_data.db` (таблица `metadata_simple`) | `test_metadata_old.py` |

---

#### Tst2 (на красный цвет)

| Поле | Источник данных v4 | Происхождение (legacy) |
|----|--------------------|------------------------|
| `test_triple` | `neuro_data.db` (таблица `metadata_color_red`) | `test_metadata_old.py` |
| `test_color` | `neuro_data.db` (таблица `metadata_color_red`) | `test_metadata_old.py` |

---

#### Tst3 (на сдвиг)

| Поле | Источник данных v4 | Происхождение (legacy) |
|----|--------------------|------------------------|
| `shift_position` | `neuro_data.db` (таблица `metadata_shift`) | `test_metadata_old.py` |
| `shift_direction` | `neuro_data.db` (таблица `metadata_shift`) | `test_metadata_old.py` |

Описание движения:

- позиции 1 и 3: вверх → вниз (150 мс);
- позиция 2: вниз → вверх (150 мс).

---

## 6. PSI: происхождение и интерпретация

### 6.1 Определение

`psi_pre_ms` — **предстимульный интервал**,  
измеряемый **от предыдущего события до тестового сигнала**.

---

### 6.2 Источники PSI

Все значения PSI **хранятся и используются из `neuro_data.db`**.

Историческое происхождение:

| Тест | Происхождение (legacy) | Характер | Источник данных v4 |
|----|------------------------|----------|--------------------|
| Tst1 | `test_metadata_old.py` | явные | таблица `metadata_simple` |
| Tst2 | `test_metadata_old.py` | агрегированные | таблица `metadata_color_red` |
| Tst3 | `test_metadata_old.py` | агрегированные | таблица `metadata_shift` |
| Warmup | `stimulus_warmup.xlsx` | явные | таблицы `warmup_*` |

Важно:

- PSI **не вычисляется на лету**;
- используется **зафиксированное значение**, перенесённое в БД.

---

## 7. RT: происхождение и ограничения

### 7.1 Источник

| Логическое поле | Источник данных v4 | Происхождение (legacy) | Тип |
|----------------|--------------------|------------------------|-----|
| `rt_ms` | `neuro_data.db` (таблица `trials`) | `boxbase.xlsx (TstX_Y)` | float |

RT хранится как `float`, несмотря на `int` в legacy-источнике:

- для нормализаций;
- для моделирования;
- без искажения исходных значений.

---

### 7.2 Валидация RT

Минимальное физиологически допустимое время реакции
задаётся на уровне методологических ограничений
и **не зависит от формата хранения данных**.

---

## 8. Контекст реакции (Reaction Context)

Контекст реакции формируется из:

- параметров дизайна теста;
- типа PSI;
- позиции и цвета стимула;
- фазы тестирования.

Все параметры контекста **извлекаются из `neuro_data.db`**
как нормализованные атрибуты событий.

---

## 9. Сопоставимость тестов Tst1 / Tst2 / Tst3

Сопоставимость обеспечивается тем, что:

- все тесты представлены в единой событийной модели;
- используются одинаковые идентификаторы сессий и стимулов;
- PSI трактуется как общий архитектурный параметр.

---

## 10. Методологические ограничения и допущения

Недопустимо:

- трактовать RT или PSI как физиологические измерения;
- игнорировать условия тестирования;
- смешивать тесты без сценарного основания.

---

## 11. Правила использования контракта

1. Контракт обязателен для кода и анализа.
2. Любые новые поля должны быть согласованы с моделью v4.
3. Legacy-источники используются **только для трассировки происхождения данных**.
4. `neuro_data.db` является единственным источником истины в v4.

---
