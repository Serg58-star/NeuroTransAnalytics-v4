# Protocol_Architecture_Alignment_v4
## Протокол согласования архитектуры v4 (Discussion ↔ Tom_1–Tom_6)

**Проект:** NeuroTransAnalytics v4  
**Документ:** Protocol_Architecture_Alignment_v4.md  
**Назначение:** зафиксировать согласованные решения по расхождениям между документом обсуждения (`NeuroTransAnalytics_Discussion_v4_Normalized`) и канонической документацией Tom_1–Tom_6.  
**Статус:** действующее проектное решение (для включения в документацию).

---
## Оглавление

- [0. Основание и принцип выбора решений](#0-основание-и-принцип-выбора-решений)
- [1. Решение: стартовая пользовательская ось (C3.4 → C3.5 → C4)](#1-решение-стартовая-пользовательская-ось-c34--c35--c4)
- [2. Решение: визуализация без C3.4](#2-решение-визуализация-без-c34)
- [3. Решение: приоритет функциональности vs методическая идеальность](#3-решение-приоритет-функциональности-vs-методическая-идеальность)
- [4. Решение: виртуальные трансформации и псевдомодификации данных](#4-решение-виртуальные-трансформации-и-псевдомодификации-данных)
- [5. Решение: GUI никогда не считает](#5-решение-gui-никогда-не-считает)
- [6. Итоговая фиксация](#6-итоговая-фиксация)
- [7. Практическое следствие для разработки](#7-практическое-следствие-для-разработки)
- [8. Архитектурно-методологический инвариант v4](#8-архитектурно-методологический-инвариант-v4)
- [9. Структура data-adapter v0](#9-структура-data-adapter-v0)


## 0. Основание и принцип выбора решений

Решения принимаются **в духе** документа обсуждения:

- **ядро строгое — интерфейс свободный**;
- функциональность расширяется через сценарии и режимы работы;
- методология не “блокирует”, а сопровождает и объясняет.

При этом канонические ограничения Tom_1–Tom_6 сохраняются там, где они обеспечивают:
- воспроизводимость,
- трассируемость,
- версионность,
- методическую допустимость интерпретаций.

---

## 1. Решение: стартовая пользовательская ось (C3.4 → C3.5 → C4)

### 1.1. Проблема
В обсуждении реализация подаётся как переход от **C3.4 → C3.5 → C4**, тогда как канон v4 требует полного каскада C3.1–C3.5.

### 1.2. Решение
**Принято как новое правило (UI/навигация):**
- основная пользовательская логика в приложении начинается со сценариев **C3.4** и ведёт к **C3.5 → C4**.

**Возврат к канону (вычислительная обязательность):**
- вычислительно C3.4 допустим **только при наличии подготовленного слоя**:
  - C3.1 (ETL),
  - C3.2 (Component Timing),
  - C3.3 (QC & Aggregation).

### 1.3. Формула компромисса
> C3.1–C3.3 не являются первичной пользовательской навигацией, но являются обязательной вычислительной инфраструктурой.

---

## 2. Решение: “визуализация без C3.4”

### 2.1. Проблема
В обсуждении допускается визуализация без C3.4 (как учебный эксперимент), тогда как канон C3.5 запрещает визуализацию без артефактов C3.4.

### 2.2. Решение
**Возврат к канону (обязательное правило):**
- слой **C3.5** визуализирует **только** стандартизированные артефакты C3.4:
  - `ScenarioResult`
  - `DistributionPack`
  - `ContrastPack`

**Принято как новое правило (расширение функционала):**
- допускается отдельный режим быстрого просмотра данных:
  - **Exploratory Preview (не-каноническая визуализация)**

Этот режим:
- не является C3.5,
- не создаёт артефактов C3.5,
- всегда маркируется как **неинтерпретируемый** на уровне C4.

### 2.3. Обязательная маркировка
Каждый график Exploratory Preview обязан иметь статус:
- `non_canonical_preview = True`
- предупреждение: **“Не является артефактом C3.5. Не подлежит интерпретации C4.”**

---

## 3. Решение: приоритет “богатство функционала” vs “методическая идеальность”

### 3.1. Проблема
В обсуждении фиксируется приоритет функциональности, тогда как канон v4 задаёт жёсткие запреты на нефомализованные действия.

### 3.2. Решение
**Принято как новое правило:**
- проект v4 реализуется как **исследовательская студия** с высокой функциональностью интерфейса,
  но со строгим вычислительным ядром.

**Возврат к канону (границы свободы):**
- свобода допускается:
  - в выборе сценариев,
  - в параметризации сценариев,
  - в навигации и режиме работы,
  - в числе параллельных представлений.

- свобода **не допускается**:
  - в нарушении вычислительных контрактов C3.4,
  - в “скрытых вычислениях” на уровне C3.5,
  - в выводах C4 без значимости/допустимости.

### 3.3. Итоговая формула
> Функционал расширяется через число сценариев и параметров, а не через снятие методологических запретов.

---

## 4. Решение: виртуальные трансформации и “псевдомодификации данных”

### 4.1. Проблема
В обсуждении виртуальные трансформации рассматриваются как центральный инструмент, но канон v4 требует нерушимости первичных данных и строгой версионности.

### 4.2. Решение
**Принято как новое правило:**
- виртуальные трансформации разрешены как отдельный режим:
  - **Simulation / Design Mode**

**Возврат к канону (обязательные требования):**
1. первичные данные **никогда не изменяются**;
2. любая трансформация оформляется как отдельная версия данных/артефактов;
3. каждый результат обязан содержать метаданные происхождения:
   - `source = historical | simulated`
   - параметры трансформации
   - `scenario_version`
   - `component_algo_version`
   - `qc_gate`

---

## 5. Решение: “GUI никогда не считает” и границы ответственности слоёв

### 5.1. Проблема
В обсуждении утверждается принцип “GUI не считает”, но местами допускается смешение группировок/контрастов как части визуализации.

### 5.2. Решение
**Принято как новое правило:**
- GUI не выполняет вычислений и не модифицирует данные.
GUI:
- собирает параметры,
- вызывает core,
- отображает артефакты,
- формирует объяснения/подсказки.

**Возврат к канону (разделение ответственности):**
- любая агрегация, контраст, группировка, вычисление значимости = **C3.4**;
- C3.5 = только отображение уже вычисленных артефактов.

---

## 6. Итоговая фиксация (коротко)

1. **UI-ось проекта:** C3.4 → C3.5 → C4 (принято).  
2. **Вычислительная инфраструктура обязательна:** C3.1–C3.3 сохраняются как канон (принято).  
3. **C3.5 визуализирует только артефакты C3.4** (возврат к канону).  
4. **Exploratory Preview разрешён**, но как неканонический режим без интерпретации (принято).  
5. **Simulation / Design Mode разрешён**, но только с версионностью и без изменения raw (принято).  
6. **GUI не считает — core считает** (принято).

---

## 7. Практическое следствие для разработки

Для реализации данных решений требуется:

- единый **Scenario Engine (C3.4)** как вычислительное ядро;
- единый формат артефактов результата (ScenarioResult/DistributionPack/ContrastPack);
- строгий визуализационный слой **C3.5**;
- отдельный слой методологического сопровождения (warnings/suggestions);
- механизм версионности и метаданных происхождения результатов.

---
## 8. Архитектурно-методологический инвариант v4

### 8.1. Основание фиксации

В результате целостной проверки объединённой документации **NeuroTransAnalytics v4**
(канонические тома Tom_1–Tom_6 в сопоставлении с summary- и discussion-материалами)
установлено отсутствие внутренних противоречий:

- архитектурных,
- методологических,
- терминологических,
- процедурных.

Настоящим документом данный факт **фиксируется как инвариант проекта v4**.

---

### 8.2. Содержание инварианта

Объединённая документация NeuroTransAnalytics v4 признаётся:

#### 8.2.1. Архитектурно согласованной

- иерархия уровней **A → B → C** логически замкнута и непротиворечива;
- пользовательская ось (UI) и вычислительная ось архитектуры разведены и согласованы;
- вычислительные слои **C3.1–C3.3** обязательны при пользовательском входе через C3.4;
- роли слоёв:
  - C3.4 (Scenario Engine),
  - C3.5 (Visualization),
  - C4 (Interpretation & Reporting)
  строго разграничены.

#### 8.2.2. Методологически замкнутой

- отсутствуют возвраты к физиологическим, клиническим или причинным интерпретациям;
- параметры ΔV1, PSI, позиция и нагрузка сохраняют инструментальный статус;
- интерпретации уровня C4 не нарушают границ сценариев уровней A и B.

#### 8.2.3. Терминологически устойчивой

- ключевые понятия используются консистентно;
- многозначные термины (например, «нагрузка») допустимы
  только при явной контекстной маркировке.

#### 8.2.4. Процедурно непротиворечивой

- вычислительные контракты слоёв v4 не нарушаются;
- GUI не выполняет вычислений и не модифицирует данные;
- визуализация C3.5 допускается только на основе артефактов C3.4;
- неканонические режимы (Exploratory Preview, Simulation / Design Mode)
  формально отделены и не участвуют в интерпретации C4.

---

### 8.3. Статус и область действия

- Инвариант действует для всей версии **v4**.
- Документация **не требует повторной гармонизации**,
  если не изменяются базовые архитектурно-методологические принципы.

---

### 8.4. Граница применимости

Инвариант подлежит пересмотру **только** в случае:

- перехода к версии **v5**, либо
- явного изменения базовых принципов архитектуры или методологии.

До этого момента повторная проверка согласованности v4 считается избыточной.


## 9. Структура data-adapter v0
*(граница C2.1 / C3.1 в архитектуре NeuroTransAnalytics v4)*

### 9.1. Назначение data-adapter v0

Data-adapter v0 предназначен для первичного преобразования legacy-данных
в канонические сущности архитектуры v4 уровня **C2.1**.

Адаптер реализует детерминированную сборку событий и **не выполняет**:

- аналитических вычислений;
- статистической обработки;
- интерпретации;
- визуализации;
- пользовательских сценариев.

---

### 9.2. Источники данных и их роли

- `users.xlsx` — источник субъектов (*Subject*);
- `boxbase.xlsx` — источник сессий и реакций (*TestSession, ResponseEvent*);
- `config_old.ini` — дизайн warmup-фазы;
- `test_metadata_old.py` (исправленная версия) — дизайн тестовых серий.

Источники рассматриваются **изолированно** и не переопределяют друг друга.

---

### 9.3. Область ответственности адаптера

Data-adapter v0:

- формирует сущности:
  - `Subject`,
  - `TestSession`,
  - `StimulusEvent`,
  - `ResponseEvent`;
- встраивает warmup-фазу;
- обеспечивает воспроизводимую индексацию событий;
- фиксирует происхождение параметров (*explicit / derived*).

Адаптер **не вычисляет** возраст, ΔV-компоненты, агрегаты и показатели качества.

---

### 9.4. Структура модулей

data_adapter/
├── adapter_v0.py          # оркестратор адаптации
├── loaders/               # загрузка источников
│   ├── users_loader.py
│   ├── boxbase_loader.py
│   └── config_loader.py
├── design/                # дизайн тестов
│   ├── warmup_design.py
│   └── test_design.py
├── builders/              # сборка сущностей C2.1
│   ├── subject_builder.py
│   ├── session_builder.py
│   ├── stimulus_builder.py
│   └── response_builder.py
└── models/                # структуры данных
    ├── subject.py
    ├── session.py
    ├── stimulus_event.py
    └── response_event.py

    Допускается техническое переименование файлов и директорий,
если сохраняются их роли и границы ответственности.

### 9.5. Порядок работы data-adapter v0

Последовательность работы data-adapter v0 фиксируется следующим образом:

1. Загрузка субъектов из `users.xlsx`;
2. Загрузка сессий и реакций из `boxbase.xlsx`;
3. Загрузка дизайна warmup-фазы из `config_old.ini`;
4. Загрузка дизайна тестовых серий из `test_metadata_old.py`;
5. Формирование сущностей `TestSession`;
6. Формирование сущностей `StimulusEvent`:
   - сначала событий с ролью `warmup`,
   - затем событий с ролью `test`;
7. Привязка сущностей `ResponseEvent` **исключительно** к тестовым `StimulusEvent`.

Данный порядок является **обязательным** и не подлежит изменению в рамках v4.

### 9.6. Инварианты data-adapter v0

В рамках архитектуры v4 для data-adapter v0 зафиксированы следующие инварианты:

1. Warmup-стимулы **всегда** формируются как `StimulusEvent` с ролью `warmup`;
2. Warmup-стимулы **никогда** не имеют связанного `ResponseEvent`;
3. Все тестовые стимулы **обязаны** иметь связанный `ResponseEvent`;
4. Предстимульные интервалы (PSI):
   - либо заданы явно (*explicit*),
   - либо вычислены (*derived*),
   с обязательной фиксацией источника;
5. Исправленный файл `test_metadata_old.py` является  
   **доверенным и каноническим источником** дизайна тестов;
6. Data-adapter v0 **не выполняет** вычислений, относящихся к уровням **C3.x и выше**.

7. Минимально допустимое время реакции (RT) зафиксировано на уровне **135 мс**.

Данный порог соответствует параметру `MinRedLight`, изменённому
в программе тестирования **25.12.2016** и отражённому в файле `config_old.ini`:

MinRedLight = 135


Тестирующее программное обеспечение не регистрировало реакции быстрее
указанного порога, поэтому аналитический слой v4 использует значение
**135 мс** как нижнюю границу допустимого RT.

Использование более жёсткого порога (например, 150 мс) приводит к
искусственному появлению некорректно помеченных ответов и нарушает
изоморфность между legacy-ПО и архитектурой v4.


Нарушение любого из указанных инвариантов считается архитектурной ошибкой.

### 9.7. Статус и развитие data-adapter v0

Структура и принципы data-adapter v0 считаются **обязательными для версии v4**.

Допускается развитие адаптера исключительно в следующих формах:

- добавление новых адаптеров (v1, v2 и т.д.);
- расширение поддерживаемых форматов legacy-данных;
- оптимизация внутренней реализации **без изменения зафиксированных принципов**.

Изменение настоящего раздела допускается **только** в случае
изменения базовых архитектурных принципов проекта NeuroTransAnalytics.
