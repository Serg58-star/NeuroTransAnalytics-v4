# Task 16 — C3.1 Real SQLite ETL Initialization

**Project:** NeuroTransAnalytics-v4  
**Branch:** feature/task-16-real-data-integration  
**Layer:** C3.1 — ETL  
**Executor:** Google Antigravity (GoAn)  
**Mode:** Planning Required  

---

## 1. Контекст фазы

Фаза: **Real Data Integration & Structural Exploration**

Bootstrap-фаза завершена.  
Работа ведётся строго по архитектуре v4.

- SQLite `neuro_data.db` — canonical store.
- ETL реализуется в соответствии с документом C3.1.
- Уровень A0 обязателен, но старт выполняется с инфраструктурного слоя C3.1.

---

## 2. Цель задачи

Реализовать детерминированный ETL-пайплайн C3.1 поверх реальной базы `neuro_data.db`.

ETL обязан:

- читать данные из SQLite;
- нормализовать таблицу `trials` в событийную модель;
- сопоставлять каждую реакцию с соответствующей записью в `metadata_*`;
- формировать унифицированную структуру событий;
- не выполнять компонентные расчёты;
- не выполнять аналитический QC;
- не выполнять сценарные вычисления;
- не модифицировать базу данных.

---

## 3. Архитектурные ограничения

### 3.1 Инварианты

1. SQLite — единственный источник истины.
2. ETL не имеет доступа к GUI.
3. ETL не импортирует слои C3.2, C3.3, C3.4, C3.5, C4.
4. Никакой интерпретации.
5. Полная идемпотентность.

### 3.2 Запрещено

- Расчёт ΔV1, ΔV4, ΔV5/MT.
- Агрегирование.
- Сценарные расчёты.
- Изменение `neuro_data.db`.

---

## 4. Источники данных (Extract)

Обязательные таблицы:

- `users`
- `trials`
- `metadata_simple`
- `metadata_color_red`
- `metadata_shift`

Warmup-таблицы в EventFrame не включаются.

---

## 5. Трансформация (Transform)

### 5.1 Нормализация реакций

Таблица `trials` содержит:

- 36 реакций для Tst1
- 36 реакций для Tst2
- 36 реакций для Tst3

ETL обязан:

1. Развернуть tstX_Y в строковую событийную модель.
2. Создать `stimulus_index` (1–36).
3. Связать каждую реакцию с соответствующей записью из `metadata_*`.

### 5.2 Обязательные поля EventFrame

| Field | Type |
|-------|------|
| subject_id | int |
| session_id | int |
| test_type | str |
| stimulus_index | int |
| rt_ms | float |
| psi_pre_ms | int |
| stimulus_color | str / None |
| stimulus_location | str / None |
| technical_qc_flag | bool |

### 5.3 Контракт данных

- PSI извлекается исключительно из `metadata_*`.
- RT приводится к float без изменения значения.
- Warmup не включается.
- Отсутствующие значения не удаляются, а маркируются.

---

## 6. Контроль технической целостности

ETL обязан проверить:

1. В каждой сессии 36 реакций на каждый тест.
2. Для каждого `stimulus_index` существует запись в metadata.
3. Типы данных корректны.
4. RT ≥ 135 мс (архитектурный порог).

При нарушении:

- запись получает `technical_qc_flag = False`;
- выполнение пайплайна не останавливается.

---

## 7. Выход ETL

### 7.1 In-memory структура

Возвращается:

EventFrame (pandas DataFrame)


### 7.2 Опциональный экспорт

Допускается метод:

export_parquet(path)


Каталог:

data/derived/events/


---

## 8. Структура реализации

Рекомендуемая структура:

core/
etl/
init.py
etl_v4.py


Рекомендуемые функции:

- `load_sqlite(path)`
- `extract_trials(conn)`
- `extract_metadata(conn)`
- `build_event_frame(...)`
- `validate_integrity(...)`

---

## 9. Definition of Done

Task считается завершённым, если:

1. ETL запускается без ошибок.
2. Количество строк = sessions × 3 × 36.
3. PSI корректно сопоставлен.
4. Warmup отсутствует.
5. RT сохранён без изменения.
6. Повторный запуск даёт идентичный результат.
7. Сформирован Walkthrough.
8. Implementation Plan утверждён до реализации.

---

## 10. Порядок выполнения

1. GoAn переходит в Planning Mode.
2. Формирует Implementation Plan.
3. Отдельно описывает:
   - механизм развёртки 36 полей,
   - стратегию маппинга metadata,
   - механизм проверки целостности.
4. План проходит архитектурную проверку.
5. После одобрения выполняется реализация.
6. Предоставляется Walkthrough.
7. Проводится аудит.
8. После Accept — Git commit пользователем.
