# C2.2 — Физическая реализация хранения данных (Physical Storage Design v4)

## 1. Назначение документа

Документ описывает **физическую реализацию хранения данных** проекта *NeuroTransAnalytics* версии v4
на основе логической модели **C2.1**.

Цель:

* обеспечить реализуемость архитектуры на персональном компьютере (Windows 10);
* сохранить всю полноту данных без редукции;
* обеспечить удобство вычислений, визуализации и расширения проекта.

Документ **не содержит программного кода**, а фиксирует архитектурные решения хранения.

---

## 2. Общая стратегия хранения

Рекомендуется гибридная стратегия:

* **SQLite** — для событийных и реляционных данных;
* **Parquet** — для крупных массивов производных и агрегатов;
* **файловая иерархия** — для сценарных результатов и визуализаций.

Такой подход:

* минимизирует инфраструктурные требования;
* масштабируется от ноутбука до рабочей станции;
* поддерживает итеративный исследовательский процесс.

---

## 3. Реляционное хранилище (SQLite)

### 3.1. Назначение

SQLite используется для хранения:

* первичных событий;
* параметров дизайна тестов;
* метаданных и версий.

---

### 3.2. Основные таблицы

#### subjects

* subject_id (PK)
* sex
* age
* age_group

#### test_sessions

* session_id (PK)
* subject_id (FK)
* test_type
* phase
* session_datetime
* test_config_version

#### stimulus_events

* stimulus_event_id (PK)
* session_id (FK)
* stimulus_role
* stimulus_color
* stimulus_location
* stimulus_position_index
* psi_test
* psi_mask
* psi_transition
* background_id
* masking_pattern_id

#### response_events

* response_event_id (PK)
* stimulus_event_id (FK)
* rt
* validity_flag
* error_type

---

### 3.3. Таблицы дизайна

#### test_configs

* test_config_id (PK)
* test_type
* color_set
* spatial_scheme
* psi_scheme
* masking_scheme
* background_scheme

#### background_configs

* background_id (PK)
* background_color
* background_dynamic_type
* background_contrast
* background_phase

#### masking_patterns

* masking_pattern_id (PK)
* pattern_type
* pattern_description

---

## 4. Хранение производных данных

### 4.1. ComponentTiming (Parquet)

Хранится в виде Parquet-файлов:

* delta_v1
* delta_v4
* delta_v5_mt
* computation_version
* filtering_params
* stimulus_event_id

Разделение:

* по версии расчёта;
* по типу теста;
* по дате расчёта.

---

### 4.2. AggregateMetrics (Parquet)

Хранит:

* агрегаты с указанием области агрегации;
* версии алгоритмов;
* ссылки на исходные события.

---

## 5. Сценарный слой хранения

### 5.1. Структура каталогов

```
data/
  raw/
  sqlite/
    neurotransanalytics_v4.db
  derived/
    component_timing/
    aggregates/
  scenarios/
    A0/
    A1/
    A2/
    B1/
    B2/
    C/
```

---

### 5.2. Сценарные результаты

Для каждого сценария:

* отдельный каталог;
* сохранение промежуточных данных;
* экспорт визуализаций;
* файл описания версии сценария.

---

## 6. Версионность и воспроизводимость

Фиксируется:

* версия базы данных;
* версия логической модели;
* версия сценариев;
* версия расчётных алгоритмов.

Никакие данные не перезаписываются без смены версии.

---

## 7. Производительность и масштабирование

Архитектура рассчитана на:

* десятки миллионов событий;
* пакетную обработку;
* интерактивный анализ агрегатов.

Используются:

* индексы в SQLite;
* колоночное хранение Parquet;
* кэширование сценарных выборок.

---

## 8. Резервное копирование и переносимость

Рекомендуется:

* регулярное резервное копирование SQLite;
* хранение Parquet-файлов как неизменяемых артефактов;
* переносимость проекта целиком через файловую структуру.

---

## 9. Итоговая роль документа

Документ C2.2 обеспечивает:

* физическую реализуемость архитектуры v4;
* согласованность с методологией C1;
* основу для реализации вычислительных пайплайнов (C3).
